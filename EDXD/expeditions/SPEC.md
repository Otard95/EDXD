# Expeditions - Feature Specification

**Status:** v1 design finalized
**Detailed Design:** See [SPEC_DECISIONS.md](./SPEC_DECISIONS.md) for complete design decisions and rationale

---

## Overview

Expeditions enable planning and tracking multi-leg journeys across the galaxy. The feature supports **non-linear route navigation** through a graph of reusable route segments connected by links, with automatic next-system clipboard copy as the **killer feature** for seamless in-game navigation.

---

## Core Concepts

### Routes

**Routes are immutable, reusable path segments** generated by external plotters (Spansh for v1). Each route contains:
- Unique ID (UUID)
- Name (defaults to "Start → Destination")
- Plotter name and parameters (ship build, neutron usage, etc.)
- List of jumps (systems with metadata: distance, fuel, scoopable, position, etc.)
- Creation timestamp

Routes are a **library of paths** that can be used in multiple expeditions or combined in different ways via links.

### Expeditions

**Expeditions are non-linear graphs** of route segments navigated via unidirectional links. An expedition contains:
- One or more routes
- Links connecting routes at identical systems
- Start point (can be mid-route)
- State: `planned`, `active`, `completed`, or `ended`
- Complete jump history (all FSDJump events while active)
- Statistics (total jumps, deviations, progress)

**Key behaviors:**
- Only **one active expedition** at a time (multiple planned/completed/ended allowed)
- **Mutable only in `planned` state** - once active, structure is locked (immutable historical record)
- **Baked route** pre-computed when starting (flat array of all jumps in order for O(1) lookups)
- **Circular routes supported** (farming, patrol routes) - must be manually ended

### Links

**Links are unidirectional connections** between routes at identical systems (same `system_id`). Each link specifies:
- System name and ID (must match in both routes)
- `from`: route ID + jump index (cached lookup)
- `to`: route ID + jump index (cached lookup)

**Rules:**
- Links connect the **same physical system** in different routes
- Only one outgoing link per position (path must be unambiguous)
- Can link from/to any point in a route (start, middle, end)
- Circular links allowed (with cycle warning)

### Baked Routes

**When an expedition becomes active**, the complete path through the graph is pre-computed and stored as a flat array (`baked_route`). This eliminates graph traversal during travel.

**Benefits:**
- Next system: `baked_route[current_baked_index + 1]` (simple array access)
- Progress: `current_baked_index / len(baked_route)`
- No link checking during travel
- Seamless route transitions (auto-follow links)
- Clear completion detection (for non-circular routes)

**Circular routes:** If the path loops back to itself, `baked_loop_back_index` stores where to wrap around when reaching the end.

---

## State Machine

Expeditions have four states:

1. **`planned`** - Designing the expedition (fully mutable)
2. **`active`** - Traveling (immutable structure, recording jumps)
3. **`completed`** - Reached the end (non-circular routes only)
4. **`ended`** - Manually stopped

**Transitions:**
- `planned` → `active`: Bake route, lock structure, start tracking
- `active` → `completed`: Auto-detected when reaching end (non-circular only)
- `active` → `ended`: Manual stop (with confirmation)

**No reverse transitions** - once active/completed/ended, the expedition is a permanent historical record.

---

## Killer Feature: Auto-Copy to Clipboard

**After every FSDJump**, EDXD automatically copies the next expected system name to the clipboard. This enables:
- **Zero alt-tabbing** - just paste into galaxy map
- **Seamless route transitions** - auto-follows links between routes
- **Works during deviations** - always shows next expected system to return to route

This transforms expeditions from reference material into an active navigation assistant.

---

## Deviation Tracking

**All jumps are recorded** while expedition is active, whether on-route or not. Each jump in history includes:
- Timestamp, system name/ID
- Flags: `on_route` (system exists in route), `expected` (was next planned jump)
- Route position if on-route
- Link traversal if applicable

**No recovery logic** - if you deviate, EDXD records it and continues showing the next expected system. You stay in control.

---

## Data Storage

Expeditions are stored as JSON files in `APP_DIR/expeditions/`:

```
expeditions/
  index.json              # Active expedition ID + list of all expeditions
  {expedition_id}.json    # Individual expedition data
  routes/
    {route_id}.json       # Individual route data
```

**Save frequency:** After every FSDJump (~40+ seconds between jumps, I/O not a concern)

**Multi-session support:** Last jump position automatically saved. On app startup, detect if player traveled while EDXD was offline and prompt to fill missing jumps.

---

## v1 Scope

**In scope:**
- Spansh plotter only
- Full state machine (planned/active/completed/ended)
- Baked routes with circular route support
- Auto-copy to clipboard
- Complete deviation tracking
- Immutable routes (always)
- Mutable expeditions (planned state only)
- Single active expedition enforcement
- JSON file storage

**Out of scope (future):**
- Multiple plotter support
- Multi-device sync
- Expedition cloning
- Route editing
- Ship change detection/validation
- Advanced validation (fuel, range, permits)
- Galaxy update handling

---

## Implementation Details

See [SPEC_DECISIONS.md](./SPEC_DECISIONS.md) for:
- Complete data structures
- FSDJump processing logic
- Baked route algorithm
- Edge case handling
- Validation rules
- Implementation patterns
- Open questions

See [SPEC_REVIEW.md](./SPEC_REVIEW.md) for:
- Full design exploration
- Alternative approaches considered
- Detailed rationale for decisions
